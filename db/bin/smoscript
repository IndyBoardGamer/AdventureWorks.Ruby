#!/usr/bin/env ruby
#
# A smoscript bin replacement for unix platforms for use by the Rails 
# db:structure:dump rake task for the ActiveRecord SQL Server adapter.
# 
# Make sure you have ssh access to your Windows box using the host
# name in your database.yml. If your windows ssh username is different 
# than your unix username, setup a ~/.ssh/conf entry that fills in the 
# details.
#

args = ARGV.dup

host = args[1].dup
ip = `ping -c 1 -t 2 #{host} | grep ms | egrep -m1 -o '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}'`.chomp
args[1] = ip # Safer on remote machine since host may not resolve remotely.

file = args[9].dup
file.sub! 'db', 'db/' # Fix filename from "dbdevelopment_structure.sql" to "db/development_structure.sql"
args[9] = file

cmd = args.join(' ')
cdir = `pwd`.chomp

`ssh #{host} \"mkdir -p db && smoscript #{cmd}\"`
`scp #{host}:#{file} #{cdir}/#{file}`

